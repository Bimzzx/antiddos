#!/bin/bash
# Script that written to protect Linux Servers/PCs and routers

# You can use some tweaks on upstream linux router
# But, in this case, you need to replace INPUT -> FORWARD
# It will be give better protection

# I recommend you to backup all data of your server before using
# And reset your sysctl file to default

# Telegram of creator: @yuk1meow

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ToDo:

# Auto-backup of iptables rules before execution
# Err handler & possible autofixer
# UFW
# Improve backup of sysctl
# Make separate file with tweaks + make symbolic link
# [maybe] make separate file with rules too
# Logs of script for debug
# Block methods of public DDoS scripts
# Limit new connections per second
# Re-add rule that blocks INVALID packets (it has caused problems before)
# Better IPv6 Protection
# Ratelimit for some L3 Protocols
# Rewrite the script to Python (maybe)
# Block TCP FIN Flood
# Add iface to config (-i -o args will be required) and use it + remove "ALLOW" for lo
# Script for auto-uninstallation
# Tarpit for some rules
# Policy "BLOCK" by default for INPUT
# Gradient instead of one color
# Variables for iptables-save etc
# OUTPUT => POSTROUTING
# Rewrite headers
# Auto-remove old netfilter rules
# -I instead of -A (i think -I is better)

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Configuration

# ipset, iptables, ip6tables (nftables)
IP="/sbin/iptables-nft"
IP6="/sbin/ip6tables-nft"
IPS="/sbin/ipset"

# SSH Port
SSH="22"

# Maximum connections per IP
CL="100"

# Logging
LOG="LOG -m limit --limit 100/min --log-level debug --log-tcp-sequence --log-tcp-options --log-ip-options"

# SYN Proxy for specified ports (Max ports here - 15)
SYNPROXY="22,23,80,443,445"

# Color
LightBlue='\033[1;36m'

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Show warning if the script is not started as root

if [ "$(whoami)" != "root" ]; then
        echo -e "${LightBlue}[!] Run this script as root" | pv -qL $[10+(-2 + RANDOM%50)]
        exit 255
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Backup sysctl file
# if it exists it will be overwritten
cp /etc/sysctl.conf /etc/sysctl.bckp

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

clear;

echo -e "${LightBlue}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "        >> AntiDDoS Script by yuki <<        "
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

while true; do
    echo -e "${LightBlue}\r"
    read -p "[+] Enable reverse-path filter? He blocks spoofed packets, but incompatible with asymmetric routing. Recommended: y >> " yn
    case $yn in
        [Yy]* ) echo "net.ipv4.conf.all.rp_filter = 1" >> /etc/sysctl.conf; break;;
        [Nn]* ) echo Okay, skipped.; break;;
        * ) echo "Enter correct answer, pls.";;
    esac
done
    read -p "[+] Enable TCP TW Recycle and TCP ECN? Recycle may cause problems with load-balancers, and ECN need to be supported by routers. Recommended: n >> "
    case $yn in
        [Yy]* ) echo "net.ipv4.tcp_ecn = 1" >> /etc/sysctl.conf; echo "net.ipv4.tcp_tw_recycle = 1" >> /etc/sysctl.conf;;
        [Nn]* ) echo Okay, skipped.;;
        * ) echo "Enter correct answer, pls.";;
    esac
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

$IP -N UDP-DoS -t raw;           # UDP DoS Block
$IP -N SYN-DoS -t raw;           # SYN DoS Block
$IP -N Conn-limit -t raw;        # Conn Limit
$IP -N TCP-Bogus-Flags -t raw;   # TCP Bogus Flags
$IP -N Port-Block -t raw;        # Block Some ports
$IP -N Fragmented -t raw;        # Block Fragmented packets
$IP -N Spoof -t raw;             # Block Spoofs
$IP -N Broadcast -t raw;         # Block Packets from broadcast
$IP -N ICMP -t raw;              # ICMP Protection

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

$IP -N DL # "DL" means DROP packet and log it
$IP -A DL -j $LOG --log-prefix "[yuki AntiDDoS] "
$IP -A DL -j DROP;

$IP -t raw -A UDP-DoS -j DROP;
$IP -t raw -A SYN-DoS -j DROP;
$IP -t raw -A Conn-limit -j DROP;
$IP -t raw -A TCP-Bogus-Flags -j DROP;
$IP -t raw -A Port-Block -j DROP;
$IP -t raw -A Fragmented -j DROP;
$IP -t raw -A Spoof -j DROP;
$IP -t raw -A Broadcast -j DROP;
$IP -t raw -A ICMP -j DROP;

# Advanced logging, maybe will be added later
# $IP -A Conn-limit -j $LOG --log-prefix "[CONN LIMIT] "
# $IP -A TCP-Bogus-Flags -j $LOG --log-prefix "[BOGUS TCP FLAG] "
# $IP -A Port-Block -j $LOG --log-prefix "[BLOCKED PORT] "
# $IP -A Badflags -m limit --limit 10/m -j LOG --log-prefix "[FRAGMENTED PACKET] "
# $IP -A Broadcast -m limit --limit 10/m -j LOG --log-prefix "[BROADCAST] "

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#   >>   Permissive rules   <<
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Allow lo without any limits
# To fix problems with reverse-proxy (like nginx)
$IP -A INPUT -i lo -j ACCEPT;
$IP -A OUTPUT -o lo -j ACCEPT;

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#      >>  Protection  <<
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Protection against UDP-DoS and SYN-DoS
$IP -t raw -A UDP-DoS -p udp --match hashlimit --hashlimit-upto 400/second --hashlimit-mode srcip --hashlimit-name udpflood -j DROP;
$IP -t raw -A SYN-DoS -p tcp --syn --match hashlimit --hashlimit-upto 4/second --hashlimit-mode srcip --hashlimit-name synflood -j DROP;

# Main ICMP Protection (Block ICMP Floods, ICMP Timestamping, etc)
$IP -t raw -A PREROUTING -p icmp --icmp-type address-mask-request -j DROP;
$IP -t raw -A PREROUTING -p icmp --icmp-type router-solicitation -j DROP;
$IP -t raw -A PREROUTING -p icmp --icmp-type timestamp-request -j DROP;
$IP -t raw -A PREROUTING -p icmp --icmp-type echo-request -j DROP;
$IP -t raw -A PREROUTING -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT;
$IP -t raw -A PREROUTING -p icmp -m limit --limit 2/s -j ACCEPT;

# Block unusual TCP MSS Value
$IP -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DL;

# Limit outgoing ICMP Port-unreachable messages
# Helps fight off UDP DDoS on random destination ports
$IP -t raw -A POSTROUTING -p icmp --icmp-type port-unreach -j DROP;
$IP -t raw -A POSTROUTING -p icmp --icmp-type port-unreach -m limit --limit 11/m -j ACCEPT;

# Block bogus TCP flags
# Helps fight off TCP Null Attack (only attack type w/o flags), TCP XMAS Attack, etc
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags FIN,RST FIN,RST -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags SYN,RST SYN,RST -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags FIN,ACK FIN -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ACK,URG URG -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ACK,FIN FIN -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ACK,PSH PSH -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ALL NONE -j DROP;
$IP -t raw -A TCP-Bogus-Flags -p tcp --tcp-flags ALL ALL -j DROP;

# Block some unsecure/useless ports
# Helps fight off: SIP Flood, CharGEN DDoS, NetBIOS AMP, SSDP AMP, etc
$IP -t raw -A Port-Block -p UDP -m multiport --dports 7,19,25,135,136,137,138,139,445,1900,3389,5060 -j DROP;
$IP -t raw -A Port-Block -p TCP -m multiport --dports 7,19,25,135,136,137,138,139,445,1900,3389,5060 -j DROP;

# Block LAND and BLAT Attack (not tested)
# $IP -t raw -A PREROUTING -s 127.0.0.1 ! -i lo -j DROP;

# Block SYN sPort less than 1024 (not tested)
# $IP -t raw -A PREROUTING -p tcp --syn --sport 1:1023 -j DROP;

# Limit NTP/DNS packets
# Helps fight off DNS AMP and NTP AMP
$IP -t raw -A PREROUTING -p udp -m multiport --sports 123,53,5432,17185,7001,1900,9000 -j DROP;
$IP -t raw -A PREROUTING -p udp --sport 123 -m limit --limit 2/s --limit-burst 1 -j ACCEPT;
$IP -t raw -A PREROUTING -p udp --sport 53 -m limit --limit 4/s -j ACCEPT;
$IP -t raw -A PREROUTING -p udp --sport 5432 -m limit --limit 4/s -j ACCEPT;

# Limit connections per one IP (max: 80)
# Helps fight off "SLOW" attacks (attacks with many connections)
$IP -t raw -A Conn-limit -p tcp -m connlimit --connlimit-above $CL -j DROP;

# Limit TCP "Reset" Packets per second
# Helps fight off TCP RST Flood
$IP -t raw -A PREROUTING -p tcp --tcp-flags RST RST -j DROP;
$IP -t raw -A PREROUTING -p tcp --tcp-flags RST RST -m limit --limit 2/s --limit-burst 2 -j ACCEPT;

# Protect SSH against many connections per second from one IP
$IP -I INPUT -p tcp --dport $SSH -m state --state NEW -m recent --set;
$IP -I INPUT -p tcp --dport $SSH -m state --state NEW -m recent --update --seconds 60 --hitcount 20 -j DROP;

# Enable SYN Proxy for specified ports
# Helps fight off powerful SYN floods
$IP -A INPUT -p tcp -m multiport --dports $SYNPROXY -m conntrack --ctstate INVALID,UNTRACKED -j SYNPROXY --timestamp --sack-perm;

# Drop all fragmented packets
# Helps fight off Fragmented TCP/UDP/ICMP Attacks
$IP -t raw -A Fragmented -f -j DROP;

# Block NEW packets that != SYN
# Helps fight off TCP ACK Flood, TCP SYN-ACK Flood, TCP RST/FIN Flood
$IP -t raw -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP;

# Block invalid packets
# Will be added later, but with limit:
# (Allow INVALID Packets, but only limited)
# $IP -A INPUT -m state --state INVALID -j DROP;

# Beta rules: Block zero-length TCP and UDP
# Helps fight off UDP-NULL, TCP-NULL attacks
$IP -t raw -A PREROUTING -p tcp -m length --length 0 -j DROP;
$IP -t raw -A PREROUTING -p udp -m length --length 0 -j DROP;

# UDP Spoofing load reduction
$IPS create antiddos_yuki hash:ip hashsize 16777216 maxelem 40000000 timeout 120;
$IP -N antiddosyuki -t raw;
$IP -A PREROUTING -p udp -m set ! --match-set antiddos_yuki src -t raw -j antiddosyuki;
$IP -A antiddosyuki -t raw -j SET --add-set antiddos_yuki src;
$IP -A antiddosyuki -t raw -j DROP;

# Block some IPs
# Here we use ipset with big hashsize, so it doesnt affect performance
$IPS create blacklist nethash hashsize 260000;
$IPS add blacklist 240.0.0.0/5;
$IPS add blacklist 172.16.0.0/12;
$IPS add blacklist 169.254.0.0/16;
$IPS add blacklist 224.0.0.0/3;
$IP -t raw -A PREROUTING -m set --match-set blacklist src -j DROP;

# Block unusual Layer3 Protocols
# Helps fight off ESP/GRE/AH Flood
# [!] May block IPsec
$IP -t raw -A PREROUTING -p esp -j DROP;
$IP -t raw -A PREROUTING -p gre -j DROP;
$IP -t raw -A PREROUTING -p ah -j DROP;

# Block all packets from broadcast
# Helps fight off Fraggle Attack & Smurf Attack
$IP -t raw -A Broadcast -m pkttype --pkt-type broadcast -j DROP;

# Just IPv6 simple protection
# Helps fight off: Simple ICMPv6 Attacks, Simple SYN Floods
$IP6 -t raw -A PREROUTING -p icmpv6 -j DROP;
$IP6 -t raw -A PREROUTING -p icmpv6 -m limit --limit 4/s -j ACCEPT;
$IP6 -t raw -A PREROUTING -p tcp --syn -m limit --limit 3/s --limit-burst 10 -j ACCEPT;


# ━━━━━━━━━━━━
# Main tweaks
# ━━━━━━━━━━━━


# Decrease some timeouts for better resistance to DDoS
echo "net.netfilter.nf_conntrack_tcp_timeout_last_ack = 10" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_tcp_timeout_close = 5" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_tcp_timeout_close_wait = 3" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_tcp_timeout_time_wait = 1" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 15" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 15" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 15" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 30" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_generic_timeout = 120" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_udp_timeout_stream = 30" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_udp_timeout = 10" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_icmp_timeout = 1" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_icmpv6_timeout = 1" >> /etc/sysctl.conf;

# SYN Cookie to fight off SYN Floods
echo "net.ipv4.tcp_syncookies = 1" >> /etc/sysctl.conf

# Increase max open files for high-loaded servers
echo "fs.file-max = 2000000" >> /etc/sysctl.conf;

# Increase max connections for better network performance
echo "net.core.somaxconn = 500000" >> /etc/sysctl.conf;

# Enable TCP TW reuse for better performance
echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf;

# Increase SYN Backlog value for resistance to attacks
echo "net.ipv4.tcp_max_syn_backlog = 1000000" >> /etc/sysctl.conf;

# Decrease SYN and SYN-ACK retries against SYN Floods
echo "net.ipv4.tcp_synack_retries = 1" >> /etc/sysctl.conf;
echo "net.ipv4.tcp_syn_retries = 2" >> /etc/sysctl.conf;

# Increase netdev backlog. Improves network speed under heavy load
echo "net.core.netdev_max_backlog = 1000000" >> /etc/sysctl.conf;

# ACK Loop DoS Attack Mitigation
echo "net.ipv4.tcp_invalid_ratelimit = 4000" >> /etc/sysctl.conf;

# RFC 1337 Against TCP TW assassinations
echo "net.ipv4.tcp_rfc1337 = 1" >> /etc/sysctl.conf;

# Increase receive and send buffers
echo "net.core.rmem_max=33554432" >> /etc/sysctl.conf;
echo "net.core.wmem_max=33554432" >> /etc/sysctl.conf;

# TCP Probing when ICMP blackhole detected
echo "net.ipv4.tcp_mtu_probing = 1" >> /etc/sysctl.conf;

# Increase route table size
echo "net.ipv6.route.max_size = 2147483647" >> /etc/sysctl.conf;
echo "net.ipv4.route.max_size = 2147483647" >> /etc/sysctl.conf;


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Other tweaks (better performance, better security.)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo "net.ipv4.conf.all.send_redirects = 0" >> /etc/sysctl.conf;
echo "net.ipv4.conf.all.accept_source_route = 0" >> /etc/sysctl.conf;
echo "net.ipv6.conf.all.accept_redirect = 0" >> /etc/sysctl.conf;
echo "net.ipv6.conf.all.accept_ra = 0" >> /etc/sysctl.conf;
echo "net.ipv6.icmp.echo_ignore_anycast = 1" >> /etc/sysctl.conf;
echo "net.ipv6.conf.all.drop_unsolicited_na = 1" >> /etc/sysctl.conf;
echo "net.ipv6.conf.all.use_tempaddr = 2" >> /etc/sysctl.conf;
echo "net.ipv4.conf.all.drop_unicast_in_l2_multicast = 1" >> /etc/sysctl.conf;
echo "net.ipv6.conf.all.drop_unicast_in_l2_multicast = 1" >> /etc/sysctl.conf;
echo "net.ipv6.icmp.echo_ignore_multicast = 1" >> /etc/sysctl.conf;
echo "net.ipv4.conf.all.drop_gratuitous_arp = 1" >> /etc/sysctl.conf;
echo "net.ipv4.conf.all.arp_ignore = 1" >> /etc/sysctl.conf;
echo "net.ipv4.igmp_link_local_mcast_reports = 0" >> /etc/sysctl.conf;
echo "kernel.dmesg_restrict = 1" >> /etc/sysctl.conf;
echo "kernel.nmi_watchdog = 0" >> /etc/sysctl.conf;
echo "fs.protected_symlinks = 1" >> /etc/sysctl.conf;
echo "fs.protected_hardlinks = 1" >> /etc/sysctl.conf;
echo "kernel.unprivileged_bpf_disabled = 1" >> /etc/sysctl.conf;
echo "kernel.sched_tunable_scaling = 1" >> /etc/sysctl.conf;
echo "net.ipv4.tcp_moderate_rcvbuf = 1" >> /etc/sysctl.conf;
echo "net.ipv4.icmp_ignore_bogus_error_responses = 1" >> /etc/sysctl.conf;
echo "net.ipv4.icmp_echo_ignore_broadcasts = 1" >> /etc/sysctl.conf;
echo "net.ipv4.conf.all.secure_redirects = 1" >> /etc/sysctl.conf;
echo "net.ipv6.conf.all.accept_redirect = 0" >> /etc/sysctl.conf;
echo "net.ipv6.echo_ignore_multicast = 1" >> /etc/sysctl.conf;
echo "net.ipv6.echo_ignore_anycast = 1" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_helper = 0" >> /etc/syctl.conf;
echo "net.ipv4.ip_local_port_range=1024 65535" >> /etc/sysctl.conf
echo "net.netfilter.nf_conntrack_tcp_loose = 0" >> /etc/sysctl.conf;
echo "net.netfilter.nf_conntrack_max = 10000000" >> /etc/sysctl.conf;
echo "kernel.sched_energy_aware = 1" >> /etc/sysctl.conf;
echo "net.ipv4.tcp_slow_start_after_idle = 0" >> /etc/sysctl.conf;

# Better domain name servers

# Cloudflare DNS:
echo "nameserver 1.1.1.1" >> /etc/resolv.conf
echo "nameserver 1.0.0.1" >> /etc/resolv.conf
# Google DNS:
echo "nameserver 8.8.8.8" >> /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf
# Quad9 DNS:
echo "nameserver 9.9.9.9" >> /etc/resolv.conf
echo "nameserver 149.112.112.112" >> /etc/resolv.conf

# Save all rules and tweaks
iptables-save;
ip6tables-save;
netfilter-persistent save;
#iptables-apply;
sysctl -p;
clear;
# Remove "clear" if you want to see stdout

echo -e "${LightBlue}"
echo "[✓] Script changes applied." | pv -qL $[10+(-2 + RANDOM%50)]
echo "[+] Use 'iptables -L -v -n -x | head' to check info about rules." | pv -qL $[10+(-2 + RANDOM%50)]
exit 0;

# ToDo:
# Add to text above some info from README.md
# For example: info about which attacks are blocked

# Want to delete rule? Replace -A (or -I) to -D and apply!

# If you want do delete ALL iptables rules,
# type iptables -F; ip6tables -F
# And do not forget to save your changes:
# iptables-save; ip6tables-save

# Made by yuki with love
